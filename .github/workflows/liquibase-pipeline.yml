name: Liquibase Pipeline (Secrets)

on:
  workflow_dispatch:
    inputs:
      target:
        description: "Environment to deploy"
        required: true
        type: choice
        options: [dev, test, prod, all]
        default: dev
      policies:
        description: "Run Liquibase checks/policies?"
        required: true
        type: choice
        options: [off, on]
        default: off
      drift:
        description: "Run drift detection (diff) after deploy?"
        required: true
        type: choice
        options: [off, on]
        default: off

permissions:
  contents: read

concurrency:
  group: liquibase-${{ github.ref }}-${{ github.event.inputs.target }}
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: self-hosted

    # If target=all -> ["dev","test","prod"], else just the selected env
    strategy:
      matrix:
        env: ${{ fromJson( github.event.inputs.target == 'all' && '["dev","test","prod"]' || format('["{0}"]', github.event.inputs.target) ) }}

    env:
      # Inject Pro license & (fallback) user/pass from repo secrets
      LIQUIBASE_PRO_LICENSE: ${{ secrets.LIQUIBASE_PRO_LICENSE }}
      LB_USER: ${{ secrets.LB_USER }}
      LB_PASSWORD: ${{ secrets.LB_PASSWORD }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Liquibase (latest Pro)
        uses: liquibase/setup-liquibase@v1
        with:
          version: 'latest'
          edition: 'pro'

      - name: Create defaults file with Pro license
        id: defaults
        run: |
          cat > liq-defaults.properties <<'PROPS'
          changeLogFile=changelog/master.xml
          liquibase.hub.mode=off
          PROPS

          if [ -n "${LIQUIBASE_PRO_LICENSE}" ]; then
            echo "liquibase.pro.licenseKey=${LIQUIBASE_PRO_LICENSE}" >> liq-defaults.properties
          fi

          echo "defaultsFile=$(pwd)/liq-defaults.properties" >> $GITHUB_OUTPUT

      - name: Map environment â†’ URL, creds, contexts
        id: envmap
        shell: bash
        run: |
          # Pull host/port/user/pass per env from GitHub Secrets
          case "${{ matrix.env }}" in
            dev)
              HOST="${{ secrets.DEV_DB_HOST }}"
              PORT="${{ secrets.DEV_DB_PORT }}"
              USER="${{ secrets.DEV_DB_USER || env.LB_USER }}"
              PASS="${{ secrets.DEV_DB_PASS || env.LB_PASSWORD }}"
              # Include 'dev' + the "all three" context (dev,test,prod)
              CONTEXTS="dev,dev,test,prod"
              ;;
            test)
              HOST="${{ secrets.TEST_DB_HOST }}"
              PORT="${{ secrets.TEST_DB_PORT }}"
              USER="${{ secrets.TEST_DB_USER || env.LB_USER }}"
              PASS="${{ secrets.TEST_DB_PASS || env.LB_PASSWORD }}"
              CONTEXTS="test,dev,test,prod"
              ;;
            prod)
              HOST="${{ secrets.PROD_DB_HOST }}"
              PORT="${{ secrets.PROD_DB_PORT }}"
              USER="${{ secrets.PROD_DB_USER || env.LB_USER }}"
              PASS="${{ secrets.PROD_DB_PASS || env.LB_PASSWORD }}"
              CONTEXTS="prod,dev,test,prod"
              ;;
          esac

          if [ -z "$HOST" ] || [ -z "$PORT" ]; then
            echo "Host/port secrets are missing for ${{ matrix.env }}. Please set them in repo settings." >&2
            exit 1
          fi

          URL="jdbc:postgresql://${HOST}:${PORT}/postgres"

          echo "url=$URL"        >> "$GITHUB_OUTPUT"
          echo "username=$USER"  >> "$GITHUB_OUTPUT"
          echo "password=$PASS"  >> "$GITHUB_OUTPUT"
          echo "contexts=$CONTEXTS" >> "$GITHUB_OUTPUT"

      - name: Show Liquibase version
        run: liquibase --version

      - name: (Optional) Run checks/policies
        if: ${{ github.event.inputs.policies == 'on' }}
        run: |
          liquibase \
            --defaultsFile="${{ steps.defaults.outputs.defaultsFile }}" \
            --url="${{ steps.envmap.outputs.url }}" \
            --username="${{ steps.envmap.outputs.username }}" \
            --password="${{ steps.envmap.outputs.password }}" \
            checks run || true

      - name: Update ${{ matrix.env }}
        run: |
          liquibase \
            --defaultsFile="${{ steps.defaults.outputs.defaultsFile }}" \
            --url="${{ steps.envmap.outputs.url }}" \
            --username="${{ steps.envmap.outputs.username }}" \
            --password="${{ steps.envmap.outputs.password }}" \
            --contexts="${{ steps.envmap.outputs.contexts }}" \
            update

      - name: (Optional) Drift detection vs. dev
        if: ${{ github.event.inputs.drift == 'on' }}
        run: |
          # Point reference at dev database for the diff
          REF="jdbc:postgresql://${{ secrets.DEV_DB_HOST }}:${{ secrets.DEV_DB_PORT }}/postgres"
          liquibase \
            --defaultsFile="${{ steps.defaults.outputs.defaultsFile }}" \
            --url="${{ steps.envmap.outputs.url }}" \
            --username="${{ steps.envmap.outputs.username }}" \
            --password="${{ steps.envmap.outputs.password }}" \
            --referenceUrl="$REF" \
            diff || true

name: Liquibase Simple Pipeline

on:
  workflow_dispatch:
    inputs:
      target:
        description: "Target environment"
        required: true
        type: choice
        options: [dev, test, prod]
        default: dev
      run_audit:
        description: "Run audits?"
        required: true
        type: choice
        options: [on, off]
        default: on
      run_drift:
        description: "Run drift?"
        required: true
        type: choice
        options: [on, off]
        default: on
      run_policies:
        description: "Run policies (checks)?"
        required: true
        type: choice
        options: [on, off]
        default: on

permissions:
  contents: read

jobs:
  liquibase:
    runs-on: self-hosted

    # Example URLs â€” replace with your own or load from GitHub Environments
    env:
      DEV_URL:  jdbc:postgresql://localhost:5433/postgres
      TEST_URL: jdbc:postgresql://localhost:5434/postgres
      PROD_URL: jdbc:postgresql://localhost:5435/postgres

    steps:
      - uses: actions/checkout@v4

      - name: Select target URL
        id: envmap
        shell: bash
        run: |
          case "${{ inputs.target }}" in
            dev)  echo "LB_URL=${{ env.DEV_URL }}"  >> $GITHUB_OUTPUT;;
            test) echo "LB_URL=${{ env.TEST_URL }}" >> $GITHUB_OUTPUT;;
            prod) echo "LB_URL=${{ env.PROD_URL }}" >> $GITHUB_OUTPUT;;
            *)    echo "Unknown target"; exit 1;;
          esac

      - name: Write liquibase.properties
        shell: bash
        env:
          LB_URL:  ${{ steps.envmap.outputs.LB_URL }}
          LB_USER: ${{ secrets.DB_USER }}
          LB_PWD:  ${{ secrets.DB_PWD }}
        run: |
          cat > liquibase.properties <<EOF
          url=${LB_URL}
          username=${LB_USER}
          password=${LB_PWD}
          EOF

      - name: Export toggles for Flow
        shell: bash
        run: |
          echo "RUN_AUDIT=${{ inputs.run_audit }}"       >> $GITHUB_ENV
          echo "RUN_DRIFT=${{ inputs.run_drift }}"       >> $GITHUB_ENV
          echo "RUN_POLICIES=${{ inputs.run_policies }}" >> $GITHUB_ENV

      - name: Run Liquibase flow
        shell: bash
        run: |
          # License will be auto-discovered by Liquibase; no --license-key needed
          liquibase flow --flow-file=liquibase.flowfile.yaml

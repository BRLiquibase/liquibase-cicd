name: Liquibase Simple Pipeline

on:
  workflow_dispatch:
    inputs:
      target:
        description: "Target environment"
        required: true
        type: choice
        options: [dev, test, prod]
        default: dev
      run_audit:
        description: "Run audits?"
        required: true
        type: choice
        options: [on, off]
        default: on
      run_drift:
        description: "Run drift (diff)?"
        required: true
        type: choice
        options: [on, off]
        default: on
      run_policies:
        description: "Run policies (checks)?"
        required: true
        type: choice
        options: [on, off]
        default: on

permissions:
  contents: read

jobs:
  liquibase:
    runs-on: self-hosted

    env:
      DEV_URL:  jdbc:postgresql://localhost:5433/postgres
      TEST_URL: jdbc:postgresql://localhost:5434/postgres
      PROD_URL: jdbc:postgresql://localhost:5435/postgres

    steps:
      - uses: actions/checkout@v4

      - name: Pick target URL
        id: envmap
        shell: bash
        run: |
          case "${{ inputs.target }}" in
            dev)  echo "LB_URL=${{ env.DEV_URL }}"  >> $GITHUB_OUTPUT;;
            test) echo "LB_URL=${{ env.TEST_URL }}" >> $GITHUB_OUTPUT;;
            prod) echo "LB_URL=${{ env.PROD_URL }}" >> $GITHUB_OUTPUT;;
            *)    echo "Unknown target"; exit 1;;
          esac

      - name: Normalize & export toggles + connections
        shell: bash
        run: |
          norm () {
            v="$(echo "$1" | tr '[:upper:]' '[:lower:]')"
            case "$v" in
              on|true|1|yes)  echo on ;;
              off|false|0|no|'') echo off ;;
              *) echo "$v" ;;
            esac
          }

          echo "RUN_AUDIT=$(norm '${{ inputs.run_audit }}')"       >> $GITHUB_ENV
          echo "RUN_DRIFT=$(norm '${{ inputs.run_drift }}')"       >> $GITHUB_ENV
          echo "RUN_POLICIES=$(norm '${{ inputs.run_policies }}')" >> $GITHUB_ENV

          echo "LB_URL=${{ steps.envmap.outputs.LB_URL }}" >> $GITHUB_ENV
          echo "LB_USER=${{ secrets.LB_USER }}"            >> $GITHUB_ENV
          echo "LB_PASSWORD=${{ secrets.LB_PASSWORD }}"    >> $GITHUB_ENV
          echo "TEST_URL=${{ env.TEST_URL }}"              >> $GITHUB_ENV

          echo "Final toggles:"
          echo "  RUN_AUDIT=${{ inputs.run_audit }}"
          echo "  RUN_DRIFT=${{ inputs.run_drift }}"
          echo "  RUN_POLICIES=${{ inputs.run_policies }}"

      - name: Run Liquibase flow
        shell: bash
        run: |
          liquibase flow --flow-file=liquibase.flowfile.yaml
